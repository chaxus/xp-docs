> 环境需求：**Node.js v16** 以上版本

### 拉取源码

```
git clone https://github.com/palxiao/poster-design.git
cd poster-design
```

### 安装依赖

```
npm run prepared
```

### 本地运行

```
npm run serve
```

> 将会同时运行前端界面与图片生成服务：
> 
> ![](../images/2023-7-16-1689498291322.png)

### 运行结果

![](../images/2023-7-16-1689500112694.gif)

合成图片时本地会启动一个Chrome浏览器实例。

### 打包前端页面

```
npm run v-build
```

### 打包图片生成服务

```
cd sreenshot
npm run build
```

### 服务端

可参考接口API文档自行实现服务端。

### 服务器配置

在Linux的环境下，浏览器没有视图界面，此时就需要使用**无头**的模式才能截图，linux浏览器正常来说npm会帮忙下载并引用好依赖，但是我实际情况下并未成功，索性自己安装浏览器并配置路径，等下会讲到，参考配置如下：

创建一份配置文件例如：`config.js`

```js
// 服务器上的浏览器路径，按你的实际路径来，默认安装路径都是在 /opt/google 下面
exports.executablePath = '/opt/google/chrome-unstable/chrome'
```



> 一些可能用到的linux命令参考：
> ```shell
> google-chrome --version # 查看浏览器版本号
> 
> apt-get update
> apt-get install -y google-chrome-stable // 安装最新稳定版谷歌浏览器
> ```

## Docker容器

可以通过docker运行一个带linux浏览器的容器，然后暴露一个截图服务以供使用，我使用的基础镜像为：
```
docker pull howard86/puppeteer_node:12
```
运行容器参考（其中映射/cache为临时目录，放生成图片用）：
```
docker run -itd -v /data/docker-home:/home -v /data/cache:/cache -p 7001:7001 --name screenshot howard86/puppeteer_node:12
```
运行后可以手动进入容器中查看谷歌浏览器版本，看需不需要升级，安装pm2作为服务启动工具，服务启动/重部署相关脚本命令参考：
```shell
docker exec screenshot /bin/bash -c 'pm2 delete screenshot-service'
docker exec screenshot /bin/bash -c 'cd /home/ && yarn'
docker exec screenshot /bin/bash -c 'pm2 start /home/screenshot-service.js'
docker exec screenshot /bin/bash -c 'pm2 flush'
```
另一种方式是在本地/服务器先运行镜像，进入容器中配置好pm2，然后把做好的容器导出为新的镜像，例如：new-design/screenshot，命令运行参考：

```
docker run -itd -u root -v ~/data/tmp/screenshot:/cache -p 9001:9001 --name screenshot2 new-design/screenshot /bin/sh  -c "/usr/local/bin/pm2 start /home/dist/server.js && /usr/local/bin/pm2 flush"
```

第二种方式比较适合在公司部署服务，把镜像丢给运维一键启动就行，每次重新部署也就是重启整个容器，比较方便。